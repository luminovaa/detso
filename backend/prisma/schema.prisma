generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// [NEW] Model untuk Perusahaan ISP (Tenant)
model Detso_Tenant {
    id         String   @id @default(cuid())
    name       String   @unique // Nama ISP, misal "Berkah Net"
    slug       String   @unique // Untuk URL, misal "berkah-net"
    logo       String?
    address    String?
    phone      String?
    is_active  Boolean  @default(true) // Jika mereka telat bayar ke kamu, bisa di-false
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    // Relasi ke semua data milik ISP ini
    users     Detso_User[]
    customers Detso_Customer[]
    services  Detso_Service_Connection[]
    packages  Detso_Package[]
    tickets   Detso_Ticket[]
    schedules Detso_Work_Schedule[]

    @@map("detso_tenants")
}

model Detso_User {
    id String @id @default(cuid())

    // [NEW] User ini milik ISP mana? (Opsional khusus untuk SAAS_SUPER_ADMIN)
    tenant_id String?
    tenant    Detso_Tenant? @relation(fields: [tenant_id], references: [id])

    username String
    email    String     @unique
    password String
    phone    String?
    role     Detso_Role @default(TENANT_TEKNISI) // [UPDATED] Enum role baru

    created_at DateTime       @default(now())
    updated_at DateTime       @updatedAt
    deleted_at DateTime?
    profile    Detso_Profile?

    refresh_tokens Detso_Refresh_Token[]
    ticket         Detso_Ticket[] // Tiket yang ditugaskan ke user ini
    schedule       Detso_Work_Schedule[]
    ticket_history Detso_Ticket_History[]

    // Validasi unik username hanya di dalam satu tenant (opsional, atau tetap global unique)
    // @@unique([username, tenant_id]) 
    // Tapi agar simpel, biarkan username unique global dulu atau handle di logic aplikasi.

    @@index([tenant_id])
    @@index([deleted_at])
    @@map("detso_users")
}

model Detso_Profile {
    id         String    @id @default(cuid())
    user_id    String    @unique
    full_name  String
    avatar     String?
    created_at DateTime  @default(now())
    updated_at DateTime  @updatedAt
    deleted_at DateTime?

    user Detso_User @relation(fields: [user_id], references: [id])

    @@index([deleted_at])
    @@map("detso_profiles")
}

model Detso_Refresh_Token {
    id          String    @id @default(cuid())
    user_id     String
    token       String    @unique
    device_info String?
    ip_address  String?
    user_agent  String?
    expires_at  DateTime
    created_at  DateTime  @default(now())
    updated_at  DateTime  @updatedAt
    revoked_at  DateTime?
    is_active   Boolean   @default(true)

    user Detso_User @relation(fields: [user_id], references: [id], onDelete: Cascade)

    @@index([user_id])
    @@index([token])
    @@map("detso_refresh_tokens")
}

model Detso_Customer {
    id String @id @default(cuid())

    // [NEW] Customer ini milik ISP mana?
    tenant_id String
    tenant    Detso_Tenant @relation(fields: [tenant_id], references: [id])

    name        String
    phone       String?
    email       String?
    nik         String?
    address     String?
    birth_date  DateTime?
    birth_place String?
    created_at  DateTime  @default(now())
    updated_at  DateTime  @updatedAt
    deleted_at  DateTime?

    documents    Detso_Customer_Document[]
    service      Detso_Service_Connection[]
    pdf          Detso_Customer_PDF[]
    whatsApp_Log Detso_WhatsApp_Log[]
    ticket       Detso_Ticket[]

    @@index([tenant_id]) // Penting untuk performa query per ISP
    @@index([deleted_at])
    @@index([phone])
    @@index([nik])
    @@map("detso_customers")
}

model Detso_WhatsApp_Log {
    id            String   @id @default(cuid())
    customer_id   String?
    phone_number  String
    message_type  String
    status        String
    error_message String?
    sent_at       DateTime @default(now())
    created_at    DateTime @default(now())
    updated_at    DateTime @updatedAt

    customer Detso_Customer? @relation(fields: [customer_id], references: [id])

    @@map("detso_whatsapp_logs")
}

model Detso_Customer_Document {
    id            String   @id @default(cuid())
    customer_id   String?
    document_type String
    document_url  String
    uploaded_at   DateTime @default(now())

    customer Detso_Customer? @relation(fields: [customer_id], references: [id])

    @@index([customer_id])
    @@map("detso_customer_documents")
}

model Detso_Service_Connection {
    id String @id @default(cuid())

    // [NEW] Service ini milik ISP mana?
    tenant_id String
    tenant    Detso_Tenant @relation(fields: [tenant_id], references: [id])

    customer_id   String
    id_pel        String? // ID Pelanggan biasanya unik per tenant, bukan global
    package_id    String
    address       String?
    package_name  String
    package_speed String
    package_price Int?
    ip_address    String?
    lat           String?
    long          String?
    mac_address   String?
    status        Detso_Customer_Status @default(ACTIVE)
    created_at    DateTime              @default(now())
    updated_at    DateTime              @updatedAt
    deleted_at    DateTime?
    notes         String?

    customer Detso_Customer        @relation(fields: [customer_id], references: [id])
    package  Detso_Package         @relation(fields: [package_id], references: [id])
    photos   Detso_Service_Photo[]
    pdf      Detso_Customer_PDF[]
    ticket   Detso_Ticket[]

    // @@unique([id_pel, tenant_id]) // Saran: ID Pelanggan unik hanya dalam 1 ISP
    @@index([tenant_id])
    @@index([deleted_at])
    @@map("detso_service_connections")
}

model Detso_Service_Photo {
    id          String   @id @default(cuid())
    service_id  String
    photo_type  String
    photo_url   String
    uploaded_at DateTime @default(now())
    notes       String?

    service Detso_Service_Connection @relation(fields: [service_id], references: [id])

    @@index([service_id])
    @@map("detso_service_photos")
}

model Detso_Customer_PDF {
    id                    String   @id @default(cuid())
    customer_id           String
    service_connection_id String
    pdf_type              String   @default("installation_report")
    pdf_path              String
    generated_at          DateTime @default(now())

    customer           Detso_Customer           @relation(fields: [customer_id], references: [id])
    service_connection Detso_Service_Connection @relation(fields: [service_connection_id], references: [id])

    @@map("detso_customer_pdfs")
}

model Detso_Package {
    id String @id @default(cuid())

    // [NEW] Paket ini milik ISP mana? (ISP A punya paket "Gold", ISP B punya paket "Super")
    tenant_id String
    tenant    Detso_Tenant @relation(fields: [tenant_id], references: [id])

    name       String
    speed      String
    price      Int
    deleted_at DateTime?
    created_at DateTime  @default(now())
    updated_at DateTime  @updatedAt

    service Detso_Service_Connection[]

    @@index([tenant_id])
    @@map("detso_packages")
}

model Detso_Ticket {
    id String @id @default(cuid())

    // [NEW] Tiket ini milik ISP mana?
    tenant_id String
    tenant    Detso_Tenant @relation(fields: [tenant_id], references: [id])

    customer_id String
    service_id  String?
    title       String
    description String
    type        TicketType     @default(PROBLEM)
    priority    TicketPriority @default(MEDIUM)
    status      TicketStatus   @default(OPEN)
    assigned_to String?
    created_at  DateTime       @default(now())
    updated_at  DateTime       @updatedAt
    resolved_at DateTime?

    customer       Detso_Customer            @relation(fields: [customer_id], references: [id])
    service        Detso_Service_Connection? @relation(fields: [service_id], references: [id])
    technician     Detso_User?               @relation(fields: [assigned_to], references: [id])
    schedule       Detso_Work_Schedule?
    ticket_history Detso_Ticket_History[]
    deleted_at     DateTime?

    @@index([tenant_id])
    @@index([type])
    @@index([status])
    @@index([customer_id])
    @@index([assigned_to])
    @@map("detso_tickets")
}

model Detso_Ticket_History {
    id          String       @id @default(cuid())
    ticket_id   String
    action      TicketAction
    description String?
    image       String?
    created_by  String?
    created_at  DateTime     @default(now())

    ticket Detso_Ticket @relation(fields: [ticket_id], references: [id])
    user   Detso_User?  @relation(fields: [created_by], references: [id])

    @@map("detso_ticket_history")
}

model Detso_Work_Schedule {
    id String @id @default(cuid())

    // [NEW] Jadwal ini milik ISP mana?
    tenant_id String
    tenant    Detso_Tenant @relation(fields: [tenant_id], references: [id])

    title         String?
    ticket_id     String?        @unique
    technician_id String
    start_time    DateTime
    end_time      DateTime?
    status        ScheduleStatus @default(SCHEDULED)
    notes         String?

    created_at DateTime      @default(now())
    updated_at DateTime?
    ticket     Detso_Ticket? @relation(fields: [ticket_id], references: [id])
    technician Detso_User    @relation(fields: [technician_id], references: [id])

    @@index([tenant_id])
    @@map("detso_work_schedules")
}

// --- ENUMS ---

enum TicketAction {
    CREATED
    UPDATED
    ASSIGNED
    STATUS_CHANGED
    PRIORITY_CHANGED
    RESOLVED
    CLOSED
    REOPENED
    SCHEDULED
    NOTE_ADDED
}

enum TicketStatus {
    OPEN
    IN_PROGRESS
    RESOLVED
    CLOSED
}

enum TicketPriority {
    LOW
    MEDIUM
    HIGH
    URGENT
}

enum ScheduleStatus {
    SCHEDULED
    COMPLETED
    CANCELLED
}

enum Detso_Customer_Status {
    ACTIVE
    INACTIVE
    SUSPENDED
}

// [NEW] Role Hierarchy
enum Detso_Role {
    // Level Platform (Milik Kamu)
    SAAS_SUPER_ADMIN // Pemilik aplikasi, bisa create Tenant baru

    // Level Tenant (Milik Klien ISP)
    TENANT_OWNER // Pemilik ISP (Super Adminnya ISP)
    TENANT_ADMIN // Admin kantor ISP
    TENANT_TEKNISI // Teknisi lapangan ISP
}

enum TicketType {
    UPGRADE
    DOWNGRADE
    PROBLEM
}
